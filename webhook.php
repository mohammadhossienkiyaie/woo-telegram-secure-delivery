<?php

require_once __DIR__ . '/src/Core/Config.php';
require_once __DIR__ . '/src/Core/Logger.php';
require_once __DIR__ . '/src/Core/Handler.php';
require_once __DIR__ . '/src/Telegram/Bot.php';
require_once __DIR__ . '/src/WordPress/OrderManager.php';

use App\Core\Config;
use App\Core\Handler;
use App\Core\Logger;

// 1. تنظیمات اولیه
$config = Config::getInstance();
$secretToken = $config->get('WEBHOOK_SECRET_TOKEN');

// 2. امنیت: تایید اصالت درخواست از طرف تلگرام
if ($secretToken) {
    $headerToken = $_SERVER['HTTP_X_TELEGRAM_BOT_API_SECRET_TOKEN'] ?? '';
    if ($headerToken !== $secretToken) {
        Logger::error("Unauthorized access attempt from IP: " . $_SERVER['REMOTE_ADDR']);
        http_response_code(403);
        exit('Unauthorized');
    }
}

// 3. نقشه محصولات (در نسخه پیشرفته این می‌تواند از دیتابیس خوانده شود)
$productMap = [
    1647 => ['4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '23', '24', '25', '26', '27', '28', '94', '95', '96', '97', '98', '99', '100', '101', '102', '103', '104', '105', '106', '107', '204', '205', '206', '207', '208', '209', '210', '211', '212', '68', '69', '129', '130', '61', '131', '132', '133', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '29', '31', '30', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '46', '45', '112', '113', '114', '115', '116', '117', '118', '119', '120', '121', '122', '123', '124', '125', '126', '129', '130', '136', '137', '138', '141', '140', '139', '142', '143', '144', '146', '145', '147', '148', '149', '150', '151', '152', '153', '154', '155', '156', '157', '158', '159', '160', '161', '162', '163', '164', '165', '166', '167', '168', '169', '170', '171', '172', '173', '174', '175', '176', '177', '178', '179', '180', '181', '182', '183', '184', '185', '186', '187', '188', '189', '190', '191', '192', '193', '194', '195', '196', '198', '199', '200', '201', '203', '218', '219', '220', '221', '222', '223', '224', '225', '226', '227', '228', '229', '230', '231', '232', '234', '235', '237', '238', '239', '240', '241', '242', '243', '244', '246', '247', '245', '248', '62', '63', '64', '65', '65', '67', '213', '214', '215', '216', '217', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '249'],
    69 => ['4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '23', '24', '25', '26', '27', '28'],
    1323 => ['94', '95', '96', '97', '98', '99', '100', '101', '102', '103', '104', '105', '106', '107', '204', '205', '206', '207', '208', '209', '210', '211', '212'],
    1571 => ['62', '63', '64', '65', '65', '67', '213', '214', '215', '216', '217'],
    1304 => ['68', '69'],
    1381 => ['129', '130'],
    1170 => ['4', '5'],
    1141 => ['61'],
    1387 => ['131', '132', '133'],
    1378 => ['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88'],
    1345 => ['108', '109', '110', '111'],
    1948 => ['250', '251', '252', '253', '254', '255', '256', '257', '258', '259', '260', '261', '262', '263', '264', '265', '266', '267', '268', '269', '270', '271', '272', '273', '274', '275', '276', '277', '278', '279', '280', '281'],
    1697 => ['136', '137', '138', '141', '140', '139', '271', '272'],
    1102 => ['29', '31', '30', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '46', '45'],
    2025 => ['112', '113', '114', '115', '116', '117', '118', '119', '120', '121', '122', '123', '124', '125', '126', '282', '283', '284', '285', '286', '287'],
    1488 => ['4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '23', '24', '25', '26', '27', '28', '61', '68', '69', '134', '135'],
    1717 => ['154', '155', '156', '157', '158', '159', '160', '161', '162', '163', '164', '165', '166', '167', '168', '169', '170', '171', '172', '173', '174', '175', '176', '177', '178', '179', '180', '181', '182', '183', '184', '185', '186', '187', '188', '189', '190', '191', '192', '193', '194', '195', '196', '198', '199', '200', '201', '202', '203'],
];

// 4. دریافت ورودی وب‌هوک
$content = file_get_contents("php://input");
$update = json_decode($content, true);

if ($update) {
    $handler = new Handler($productMap);
    $handler->handle($update);
}
